<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sound Quiz</title>
  <style>
    :root { --bg:#0b0b10; --card:#141423; --text:#f2f2f7; --muted:#a6a6b3; --ok:#38d996; --ng:#ff5a6a; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: linear-gradient(180deg, #0b0b10, #07070b); color:var(--text); }
    .wrap { max-width: 560px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(20,20,35,.9); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 16px; box-shadow: 0 12px 30px rgba(0,0,0,.35); }
    .top { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .badge { font-size: 12px; color: var(--muted); }
    h1 { font-size: 18px; margin:0; }
    .desc { color: var(--muted); font-size: 13px; margin: 8px 0 0; }
    .q { margin-top: 12px; font-size: 16px; line-height: 1.5; }
    .audioRow { margin-top: 12px; display:flex; gap:10px; align-items:center; }
    audio { width: 100%; }
    .choices { margin-top: 14px; display:grid; gap:10px; }
    button.choice {
      width: 100%; text-align:left; padding: 14px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text); font-size: 16px;
      cursor:pointer;
    }
    button.choice:active { transform: scale(.99); }
    .imgGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .imgChoice { border-radius: 14px; overflow:hidden; border: 2px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
    .imgChoice button { padding:0; border:0; background:transparent; width:100%; cursor:pointer; }
    .imgChoice img { width:100%; height:140px; object-fit:cover; display:block; }
    .feedback { margin-top: 12px; font-weight: 700; }
    .feedback.ok { color: var(--ok); }
    .feedback.ng { color: var(--ng); }
    .bottom { margin-top: 14px; display:flex; gap:10px; }
    .pill {
      flex:1; padding: 12px 14px; border-radius: 14px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.08); color: var(--text); font-weight:700; cursor:pointer;
    }
    .pill.secondary { background: rgba(255,255,255,.04); font-weight:600; color: var(--muted); }
    .tiny { margin-top: 10px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1 id="title">Sound Quiz</h1>
          <div class="desc" id="description"></div>
        </div>
        <div class="badge" id="progress">- / -</div>
      </div>

      <div class="q" id="prompt">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>

      <div class="audioRow">
        <span>üéß</span>
        <audio id="audio" controls preload="auto"></audio>
      </div>

      <div class="choices" id="choices"></div>

      <div class="feedback" id="feedback" style="display:none;"></div>

      <div class="bottom">
        <button class="pill secondary" id="retryBtn">üîÅ „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
        <button class="pill" id="nextBtn">Ê¨°„Å∏ ‚ñ∂</button>
      </div>

      <div class="tiny" id="score"></div>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const setName = qs.get("set") || "set-001";
  const setUrl = `sets/${setName}.json`;

  let data = null;
  let idx = 0;
  let correct = 0;
  let locked = false;

  const el = (id) => document.getElementById(id);

  function setFeedback(text, ok) {
    const f = el("feedback");
    f.style.display = "block";
    f.textContent = text;
    f.className = "feedback " + (ok ? "ok" : "ng");
  }

  function clearFeedback() {
    const f = el("feedback");
    f.style.display = "none";
    f.textContent = "";
    f.className = "feedback";
  }

  function render() {
    locked = false;
    clearFeedback();
    el("choices").innerHTML = "";

    const item = data.items[idx];
    el("progress").textContent = `${idx + 1} / ${data.items.length}`;
    el("prompt").textContent = item.prompt || "";

    const audio = el("audio");
    if (item.audio) {
      audio.src = item.audio;
      audio.style.display = "";
    } else {
      audio.removeAttribute("src");
      audio.style.display = "none";
    }

    // Score text
    el("score").textContent = `Ê≠£Ëß£Êï∞: ${correct} / ${data.items.length}`;

    if (item.type === "mcq") {
      item.choices.forEach((c, i) => {
        const b = document.createElement("button");
        b.className = "choice";
        b.textContent = c;
        b.onclick = () => choose(i);
        el("choices").appendChild(b);
      });
    } else if (item.type === "image-mcq") {
      const grid = document.createElement("div");
      grid.className = "imgGrid";

      item.images.forEach((src, i) => {
        const box = document.createElement("div");
        box.className = "imgChoice";
        const btn = document.createElement("button");
        btn.onclick = () => choose(i);
        const img = document.createElement("img");
        img.src = src;
        img.alt = `choice-${i+1}`;
        btn.appendChild(img);
        box.appendChild(btn);
        grid.appendChild(box);
      });

      el("choices").appendChild(grid);
    } else {
      el("choices").innerHTML = `<div style="color:var(--muted)">„Åì„ÅÆtype„ÅØ„Åæ„Å†Êú™ÂØæÂøú: ${item.type}</div>`;
    }
  }

  function choose(choiceIndex) {
    if (locked) return;
    locked = true;

    const item = data.items[idx];
    const ok = choiceIndex === item.answerIndex;
    if (ok) correct++;

    setFeedback(ok ? "‚≠ï Correct!" : "‚ùå Almost‚Ä¶", ok);
    el("score").textContent = `Ê≠£Ëß£Êï∞: ${correct} / ${data.items.length}`;
  }

  function next() {
    if (!data) return;
    if (idx < data.items.length - 1) {
      idx++;
      render();
    } else {
      // Finish
      el("prompt").textContent = "üéâ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ";
      el("choices").innerHTML = "";
      el("audio").style.display = "none";
      setFeedback(`ÁµêÊûú: ${correct} / ${data.items.length}`, true);
      el("progress").textContent = "Done";
    }
  }

  function retry() {
    const audio = el("audio");
    if (audio && audio.src) {
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }
  }

  el("nextBtn").addEventListener("click", next);
  el("retryBtn").addEventListener("click", retry);

  async function init() {
    const res = await fetch(setUrl, { cache: "no-store" });
    if (!res.ok) throw new Error("„Çª„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ: " + setUrl);
    data = await res.json();
    el("title").textContent = data.title || "Sound Quiz";
    el("description").textContent = data.description || "";
    render();
  }

  init().catch(err => {
    el("prompt").textContent = "Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü‚Ä¶";
    el("choices").innerHTML = `<div style="color:var(--muted); margin-top:10px">${err.message}</div>`;
    el("audio").style.display = "none";
    el("progress").textContent = "-";
  });
</script>
</body>
</html>
