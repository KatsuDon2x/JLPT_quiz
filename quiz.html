<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Micro Japanese Hack Quiz</title>

  <style>
    :root{
      --bg:#05070b;
      --panel: rgba(18,24,33,.78);
      --panel2: rgba(10,14,20,.72);
      --line: rgba(255,255,255,.10);
      --text:#eef5ff;
      --muted: rgba(238,245,255,.72);
      --lime:#C1FF72;
      --orange:#FFC61A;
      --blue:#4da3ff;
      --r:18px;
      --gap:12px;
      --shadow: 0 18px 70px rgba(0,0,0,.62);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(193,255,114,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(255,198,26,.18), transparent 55%),
        radial-gradient(900px 520px at 45% 120%, rgba(77,163,255,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 980px; margin:0 auto; padding: 14px 14px 22px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 8px 2px 14px;
    }
    .leftTop{ display:flex; align-items:center; gap:10px; min-width:220px; }
    .xbtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      display:grid;place-items:center;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .uiToggle{
      border:1px solid rgba(193,255,114,.35);
      background: rgba(193,255,114,.10);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing:.2px;
      box-shadow:
        0 0 0 2px rgba(193,255,114,.10) inset,
        0 0 22px rgba(193,255,114,.18);
    }
    .uiDot{
      width:10px;height:10px;border-radius:999px;
      background: var(--lime);
      box-shadow: 0 0 22px rgba(193,255,114,.75);
    }
    .uiLabel{ font-size: 13px; opacity: .95; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{ padding: 14px; }
    .row{ display:flex; gap: var(--gap); align-items:flex-start; flex-wrap:wrap; }

    .speakerBtn{
      width:72px; height:72px; border-radius: 18px;
      border:1px solid rgba(77,163,255,.30);
      background: rgba(77,163,255,.14);
      display:grid; place-items:center;
      cursor:pointer;
      flex: 0 0 auto;
      position: relative;
      overflow:hidden;
      box-shadow:
        0 0 0 2px rgba(77,163,255,.10) inset,
        0 0 24px rgba(77,163,255,.18);
    }
    .speakerBtn::after{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(circle at 30% 30%, rgba(77,163,255,.36), transparent 50%);
      transform: rotate(10deg);
      opacity:.85;
    }
    .speakerBtn > *{ position:relative; z-index:1; }
    .speakerBtn:active{ transform: translateY(1px); }

    .speakerIcon{ width:28px;height:28px; fill: var(--text); opacity:.95; }

    .bubble{
      flex: 1 1 320px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px 14px;
      min-height: 72px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .qtype{
      font-weight: 1000;
      letter-spacing:.2px;
      line-height:1.25;
      font-size: 18px;
    }
    .qtype .enSmall{
      display:block;
      margin-top:6px;
      font-size: 14px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing:.1px;
    }

    .ks{
      margin-top: 12px;
      padding: 14px 14px;
      background: rgba(10,14,20,.58);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      line-height: 1.55;
    }
    .ks .jp{
      font-size: 30px;
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.45;
    }
    .ks .en{
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.55;
    }

    .choices{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .choiceBtn{
      min-height: 66px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 15px;
      font-weight: 950;
      padding: 10px 12px;
      cursor:pointer;
      text-align:center;
      line-height: 1.15;
      transition: transform 80ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
    }
    .choiceBtn:active{ transform: translateY(1px); }
    .choiceBtn.selected{
      border-color: rgba(77,163,255,.75);
      background: rgba(77,163,255,.22);
      box-shadow:
        0 0 0 2px rgba(77,163,255,.14) inset,
        0 0 26px rgba(77,163,255,.18);
    }

    .bottomRow{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .checkBtn{
      flex: 1 1 260px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(193,255,114,.55);
      background: linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.55));
      color: rgba(10,18,6,.98);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      box-shadow:
        0 0 0 2px rgba(255,255,255,.08) inset,
        0 0 34px rgba(193,255,114,.35),
        0 0 70px rgba(193,255,114,.12);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .checkBtn:disabled{
      opacity:.42;
      cursor:not-allowed;
      filter: grayscale(.35);
      box-shadow: 0 0 0 2px rgba(255,255,255,.05) inset;
      background: linear-gradient(180deg, rgba(193,255,114,.35), rgba(193,255,114,.16));
    }

    /* mini markup styles */
    .hl{ background: rgba(193,255,114,.22); padding: .05em .25em; border-radius: .35em; }
    .big{ font-size: 1.12em; font-weight: 1000; }
    .small{ font-size: .92em; opacity: .92; }

    /* feedback */
    .overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.42);
      opacity:0; pointer-events:none;
      transition: opacity 180ms ease;
      z-index: 80;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .sheet{
      position: fixed; left:0; right:0; bottom:0;
      transform: translateY(110%);
      transition: transform 220ms ease;
      z-index: 90;
      padding: 12px 16px 18px;
    }
    .sheet.show{ transform: translateY(0%); }
    .sheetInner{
      max-width: 980px; margin:0 auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow: 0 -22px 80px rgba(0,0,0,.72);
      background: rgba(10,14,20,.92);
      backdrop-filter: blur(10px);
    }
    .sheetBar{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-weight: 1100;
      letter-spacing:.2px;
    }
    .sheetBody{ padding: 14px 16px 16px; line-height: 1.55; }
    .continueBtn{
      width: 100%;
      margin-top: 12px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
    }

    @media (max-width: 720px){
      .choices{ grid-template-columns: 1fr; }
      .ks .jp{ font-size: 26px; }
      .qtype{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="leftTop">
        <button class="xbtn" id="btnExit" aria-label="exit">√ó</button>
        <div class="pills">
          <div class="pill" id="pillQ">Q 1/1</div>
          <div class="pill" id="pillScore">score: 0/1</div>
        </div>
      </div>

      <button class="uiToggle" id="btnToggleUI" type="button" aria-label="toggle ui language">
        <span class="uiDot" aria-hidden="true"></span>
        <span class="uiLabel" id="uiLabel">English UI</span>
      </button>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="row">
          <button class="speakerBtn" id="btnPlay" type="button" aria-label="play or pause audio">
            <svg class="speakerIcon" id="playIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7L8 5z"></path>
            </svg>
            <svg class="speakerIcon" id="pauseIcon" viewBox="0 0 24 24" aria-hidden="true" style="display:none;">
              <path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"></path>
            </svg>
          </button>

          <div class="bubble">
            <div class="qtype" id="qTypeBox"></div>
          </div>
        </div>

        <div class="ks" id="keySentence"></div>

        <div class="choices" id="choices"></div>

        <div class="bottomRow">
          <button class="checkBtn" id="btnCheck" type="button" disabled>„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã / CHECK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FEEDBACK SHEET -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetInner">
      <div class="sheetBar" id="sheetBar"></div>
      <div class="sheetBody" id="sheetBody"></div>
    </div>
  </div>

  <audio id="qAudio" preload="auto"></audio>

  <script>
    // ---------- URL param ----------
    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }
    const SET_ID = getParam("set"); // e.g. A1_SELF_001

    // ---------- state ----------
    let QUESTIONS = [];
    let idx = 0;
    let uiMode = "en";
    let selectedChoice = "";
    let score = 0;
    let answered = false;
    let isPlaying = false;

    // ---------- elements ----------
    const uiLabel = document.getElementById("uiLabel");
    const btnToggleUI = document.getElementById("btnToggleUI");

    const qTypeBox = document.getElementById("qTypeBox");
    const keySentence = document.getElementById("keySentence");
    const choicesEl = document.getElementById("choices");
    const btnCheck = document.getElementById("btnCheck");

    const btnPlay = document.getElementById("btnPlay");
    const playIcon = document.getElementById("playIcon");
    const pauseIcon = document.getElementById("pauseIcon");
    const qAudio = document.getElementById("qAudio");

    const pillScore = document.getElementById("pillScore");
    const pillQ = document.getElementById("pillQ");

    const overlay = document.getElementById("overlay");
    const sheet = document.getElementById("sheet");
    const sheetBar = document.getElementById("sheetBar");
    const sheetBody = document.getElementById("sheetBody");

    // ---------- mini markup (CSV-friendly) ----------
    function miniMarkup(s){
      s = String(s || "");

      // normalize newlines
      s = s.replace(/\r\n/g, "\n");

      // escape nothing (you control CSV), but convert your pseudo tags:
      const reps = [
        [/\[b\]/g, "<b>"], [/\[\/b\]/g, "</b>"],
        [/\[u\]/g, "<u>"], [/\[\/u\]/g, "</u>"],
        [/\[hl\]/g, '<span class="hl">'], [/\[\/hl\]/g, "</span>"],
        [/\[big\]/g, '<span class="big">'], [/\[\/big\]/g, "</span>"],
        [/\[small\]/g, '<span class="small">'], [/\[\/small\]/g, "</span>"],
        [/\[ruby\]/g, "<ruby>"], [/\[\/ruby\]/g, "</ruby>"],
        [/\[rt\]/g, "<rt>"], [/\[\/rt\]/g, "</rt>"],
      ];
      for (const [a,b] of reps) s = s.replace(a,b);

      // line breaks (keep it simple)
      s = s.replace(/\n/g, "<br>");
      return s;
    }

    // ---------- CSV parser (quoted commas OK) ----------
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; iJBEL) return;

      // (We don't use answer_json for listen_only; for MC we do)
      function resetPerQuestionState(){
        selectedChoice = "";
        answered = false;
        try{ qAudio.pause(); }catch(e){}
        setPlayUI(false);
      }

      function setPlayUI(playing){
        isPlaying = playing;
        playIcon.style.display = playing ? "none" : "block";
        pauseIcon.style.display = playing ? "block" : "none";
      }

      function updateCheckEnabled(){
        btnCheck.disabled = !selectedChoice || answered;
      }

      function hideSheet(){
        overlay.classList.remove("show");
        sheet.classList.remove("show");
      }

      function showSheet(ok){
        overlay.classList.add("show");
        sheet.classList.add("show");

        if (ok){
          sheetBar.style.background = "linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.45))";
          sheetBar.style.color = "rgba(10,18,6,.98)";
          sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
            <span>„Äá „ÇÑ„Å£„ÅüÔºÅ</span><span style="opacity:.72">/ Yatta!</span><span style="font-size:22px;">üéâ</span>
          </div>`;
        }else{
          sheetBar.style.background = "linear-gradient(180deg, rgba(255,198,26,.98), rgba(255,198,26,.48))";
          sheetBar.style.color = "rgba(30,18,0,.98)";
          sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
            <span>√ó „Åä„Åó„ÅÑÔºÅ</span><span style="opacity:.72">/ Oshƒ´!</span>
          </div>`;
        }

        sheetBody.innerHTML = `<button class="continueBtn" id="btnContinue">CONTINUE / „Å§„Å•„Åë„Çã</button>`;
        document.getElementById("btnContinue").addEventListener("click", ()=>{
          hideSheet();
          goNext();
        });
      }

      function goNext(){
        if (idx < QUESTIONS.length - 1){
          idx++;
          resetPerQuestionState();
          render();
        }else{
          overlay.classList.add("show");
          sheet.classList.add("show");
          sheetBar.style.background = "linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.45))";
          sheetBar.style.color = "rgba(10,18,6,.98)";
          sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
            <span>üéâ FINISH!</span><span style="opacity:.72">/ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</span>
          </div>`;
          sheetBody.innerHTML = `<div style="font-weight:950;margin-bottom:10px;">score: ${score}/${QUESTIONS.length}</div>
            <button class="continueBtn" id="btnRestart">RESTART / „Åï„ÅÑ„Åó„Çá„Åã„Çâ</button>`;
          document.getElementById("btnRestart").addEventListener("click", ()=> location.href = "index.html");
        }
      }

      function currentQ(){
        return QUESTIONS[idx] || null;
      }

      // ---------- rendering ----------
      function render(){
        const Q = currentQ();
        if (!Q) return;

        pillQ.textContent = `Q ${idx+1}/${QUESTIONS.length}`;
        pillScore.textContent = `score: ${score}/${QUESTIONS.length}`;
        uiLabel.textContent = (uiMode === "en") ? "English UI" : "Êó•Êú¨Ë™ûUI";

        // qtype
        const qtypeText = (uiMode === "en")
          ? (Q.prompt_en || "")
          : (Q.prompt_ja || "");
        qTypeBox.innerHTML = miniMarkup(qtypeText);

        // ‚Äúkey sentence‚Äù area: for now show same as prompt (you can later add separate fields)
        keySentence.innerHTML = `<div class="jp">${miniMarkup(Q.prompt_ja || "")}</div>`
          + ((uiMode === "en") ? `<div class="en">${miniMarkup(Q.prompt_en || "")}</div>` : "");

        // audio
        qAudio.src = Q.audio || "";
        qAudio.loop = true;

        // choices
        choicesEl.innerHTML = "";
        const ch = Q.choices || [];
        for (let i=0; i<ch.length; i++){
          const label = ch[i];
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choiceBtn" + ((selectedChoice===String(i)) ? " selected" : "");
          btn.innerHTML = miniMarkup(label);
          btn.addEventListener("click", ()=>{
            if (answered) return;
            selectedChoice = String(i);
            updateCheckEnabled();
            render();
          });
          choicesEl.appendChild(btn);
        }

        updateCheckEnabled();
      }

      // ---------- load + map CSV ----------
      async function loadQuestions(){
        // IMPORTANT: correct path
        const res = await fetch("data/questions.csv", { cache: "no-store" });
        if (!res.ok) throw new Error("questions.csv fetch failed: " + res.status);
        const text = await res.text();
        const rows = parseCSV(text);

        // filter by set (if provided)
        const filtered = SET_ID ? rows.filter(r => String(r.set_id||"").trim() === SET_ID) : rows;

        QUESTIONS = filtered.map(r => {
          let choices = [];
          let answer = {};
          try{ choices = JSON.parse(r.choices_json || "[]"); }catch(e){ choices = []; }
          try{ answer = JSON.parse(r.answer_json || "{}"); }catch(e){ answer = {}; }

          return {
            question_id: (r.question_id||"").trim(),
            set_id: (r.set_id||"").trim(),
            type: (r.type||"").trim(),
            prompt_ja: r.prompt_ja || "",
            prompt_en: r.prompt_en || "",
            audio: r.audio || "",
            image: r.image || "",
            choices,
            answer
          };
        }).filter(q => q.question_id);

        if (!QUESTIONS.length){
          throw new Error("No questions for set=" + (SET_ID||"(none)"));
        }
      }

      // ---------- check answer ----------
      function isCorrect(Q){
        if (Q.type === "listen_only"){
          return true; // listen_only always ‚Äúok‚Äù (tap -> continue)
        }
        // multiple_choice_text: answer_json = {"correct_index":0}
        const ci = (Q.answer && typeof Q.answer.correct_index !== "undefined") ? String(Q.answer.correct_index) : "";
        return selectedChoice === ci;
      }

      // ---------- events ----------
      btnToggleUI.addEventListener("click", ()=>{
        uiMode = (uiMode === "en") ? "jp" : "en";
        render();
      });

      document.getElementById("btnExit").addEventListener("click", ()=> location.href="index.html");

      btnPlay.addEventListener("click", ()=>{
        try{
          if (!isPlaying){ qAudio.play(); setPlayUI(true); }
          else { qAudio.pause(); setPlayUI(false); }
        }catch(e){}
      });

      btnCheck.addEventListener("click", ()=>{
        const Q = currentQ();
        if (!Q) return;
        if (answered) return;

        // listen_only: don‚Äôt require choice
        if (Q.type === "listen_only"){
          answered = true;
          score++;
          showSheet(true);
          render();
          return;
        }

        if (!selectedChoice) return;

        answered = true;
        const ok = isCorrect(Q);
        if (ok) score++;
        showSheet(ok);
        render();
      });

      overlay.addEventListener("click", hideSheet);

      // ---------- start ----------
      (async ()=>{
        try{
          await loadQuestions();
          idx = 0;
          resetPerQuestionState();
          render();
        }catch(err){
          console.error(err);
          keySentence.innerHTML = `<div class="jp" style="font-size:18px;font-weight:900;">
            Error: ${String(err.message || err)}
          </div>`;
        }
      })();
  </script>
</body>
</html>
