<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Micro Japanese Hack</title>
  <style>
    :root{
      --bg:#05070b;
      --panel: rgba(18,24,33,.78);
      --line: rgba(255,255,255,.10);
      --text:#eef5ff;
      --muted: rgba(238,245,255,.72);
      --lime:#C1FF72;
      --r:18px;
      --shadow: 0 18px 70px rgba(0,0,0,.62);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(193,255,114,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(255,198,26,.18), transparent 55%),
        radial-gradient(900px 520px at 45% 120%, rgba(77,163,255,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 980px; margin:0 auto; padding: 14px 14px 22px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; padding: 8px 2px 14px; }
    .xbtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      display:grid;place-items:center;
    }
    .title{ text-align:center; font-weight:900; letter-spacing:.2px; opacity:.9; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{ padding: 18px; }
    h1{ margin:0 0 6px; font-size: 34px; letter-spacing:.2px; }
    .sub{ color:var(--muted); margin-bottom: 14px; }
    .filters{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 14px; }
    select{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      outline:none;
    }
    .setList{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .setRow{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .thumb{
      width:52px;height:52px;border-radius:14px;
      background: rgba(255,255,255,.92);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .thumb img{ width:100%;height:100%; object-fit:cover; display:block; }
    .meta{ flex:1; min-width: 220px; }
    .meta .ja{ font-weight:950; font-size: 18px; line-height:1.2; }
    .meta .en{ color:var(--muted); font-weight:800; margin-top:4px; font-size: 13px; }
    .tagline{ color: rgba(238,245,255,.86); font-size: 13px; margin-top:6px; }
    .pick{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .startBtn{
      width:100%;
      margin-top: 14px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(193,255,114,.55);
      background: linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.55));
      color: rgba(10,18,6,.98);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow:
        0 0 0 2px rgba(255,255,255,.08) inset,
        0 0 34px rgba(193,255,114,.35),
        0 0 70px rgba(193,255,114,.12);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .startBtn:disabled{
      opacity:.35; cursor:not-allowed; filter: grayscale(.35);
      background: linear-gradient(180deg, rgba(193,255,114,.35), rgba(193,255,114,.16));
      box-shadow: 0 0 0 2px rgba(255,255,255,.05) inset;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="xbtn" id="btnExit" aria-label="exit">×</button>
      <div class="title">Micro Japanese Hack</div>
      <div style="width:42px;"></div>
    </div>

    <div class="card">
      <div class="inner">
        <h1>Choose a Quiz</h1>
        <div class="sub">Pick one set. (Single select for now.)</div>

        <div class="filters">
          <select id="fLevel">
            <option value="">All levels</option>
          </select>
          <select id="fTopic">
            <option value="">All topics</option>
          </select>
        </div>

        <div class="setList" id="setList"></div>

        <button class="startBtn" id="btnStart" disabled>START</button>
      </div>
    </div>
  </div>

<script>
  // ===== mini markup -> HTML (safe enough for your own CSV) =====
  function applyMiniMarkup(s){
    s = String(s ?? "");
    // convert \n to <br>
    s = s.replace(/\\n/g, "<br>");

    // ruby: [ruby]漢字[rt]かんじ[/rt][/ruby]
    s = s.replace(/\[ruby\]([\s\S]*?)\[rt\]([\s\S]*?)\[\/rt\]\[\/ruby\]/g, "<ruby>$1<rt>$2</rt></ruby>");

    // basic tags
    s = s.replace(/\[b\]([\s\S]*?)\[\/b\]/g, "<b>$1</b>");
    s = s.replace(/\[u\]([\s\S]*?)\[\/u\]/g, "<u>$1</u>");
    s = s.replace(/\[hl\]([\s\S]*?)\[\/hl\]/g, '<span style="background:rgba(193,255,114,.22);padding:.06em .25em;border-radius:.35em;">$1</span>');
    s = s.replace(/\[big\]([\s\S]*?)\[\/big\]/g, '<span style="font-size:1.15em;font-weight:950;">$1</span>');
    s = s.replace(/\[small\]([\s\S]*?)\[\/small\]/g, '<span style="font-size:.92em;opacity:.9;">$1</span>');

    return s;
  }

  // ===== CSV parser (quoted commas/newlines OK) =====
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];

      if (inQuotes){
        if (c === '"' && n === '"'){ cur += '"'; i++; continue; }
        if (c === '"'){ inQuotes = false; continue; }
        cur += c; continue;
      }
      if (c === '"'){ inQuotes = true; continue; }
      if (c === ","){ row.push(cur); cur=""; continue; }
      if (c === "\r"){ continue; }
      if (c === "\n"){
        row.push(cur); cur="";
        if (row.some(v => (v||"").trim().length)) rows.push(row);
        row=[]; continue;
      }
      cur += c;
    }
    row.push(cur);
    if (row.some(v => (v||"").trim().length)) rows.push(row);

    if (!rows.length) return [];
    const headers = rows.shift().map(h => (h||"").trim());
    return rows.map(cols=>{
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (cols[i] ?? ""));
      return obj;
    });
  }

  const els = {
    list: document.getElementById("setList"),
    start: document.getElementById("btnStart"),
    fLevel: document.getElementById("fLevel"),
    fTopic: document.getElementById("fTopic"),
    exit: document.getElementById("btnExit"),
  };

  let sets = [];
  let selectedSetId = "";

  function uniq(arr){
    return [...new Set(arr.filter(Boolean))];
  }

  function buildFilters(){
    const levels = uniq(sets.map(s => (s.level_band || "").trim()));
    const topics = uniq(sets.map(s => (s.topic || "").trim()));

    for (const lv of levels){
      const o = document.createElement("option");
      o.value = lv; o.textContent = lv;
      els.fLevel.appendChild(o);
    }
    for (const tp of topics){
      const o = document.createElement("option");
      o.value = tp; o.textContent = tp;
      els.fTopic.appendChild(o);
    }
  }

  function getFilteredSets(){
    const lv = els.fLevel.value;
    const tp = els.fTopic.value;
    return sets.filter(s=>{
      if ((s.is_published||"").trim().toUpperCase() === "FALSE") return false;
      if (lv && (s.level_band||"").trim() !== lv) return false;
      if (tp && (s.topic||"").trim() !== tp) return false;
      return true;
    }).sort((a,b)=> Number(a.sort_order||0) - Number(b.sort_order||0));
  }

  function render(){
    const list = getFilteredSets();
    els.list.innerHTML = "";

    for (const s of list){
      const row = document.createElement("div");
      row.className = "setRow";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.src = s.thumb_image || "";
      img.alt = "thumb";
      thumb.appendChild(img);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div class="ja">${applyMiniMarkup(s.title_ja || "")}</div>
        <div class="en">${applyMiniMarkup(s.title_en || "")}</div>
        <div class="tagline">${applyMiniMarkup(s.subtitle_en || "")}</div>
      `;

      const pick = document.createElement("label");
      pick.className = "pick";
      pick.innerHTML = `
        <input type="radio" name="pickSet" ${selectedSetId===s.set_id ? "checked":""}/>
        Select
      `;
      pick.addEventListener("click", ()=>{
        selectedSetId = (s.set_id || "").trim();
        els.start.disabled = !selectedSetId;
        render();
      });

      row.appendChild(thumb);
      row.appendChild(meta);
      row.appendChild(pick);
      els.list.appendChild(row);
    }

    els.start.disabled = !selectedSetId;
  }

  async function loadSets(){
    // IMPORTANT: use ./data/... to avoid weird base path issues
    const res = await fetch("./data/sets.csv", { cache:"no-store" });
    if (!res.ok) throw new Error("sets.csv fetch failed: " + res.status);
    const text = await res.text();
    sets = parseCSV(text);
  }

  els.fLevel.addEventListener("change", ()=>{ selectedSetId=""; render(); });
  els.fTopic.addEventListener("change", ()=>{ selectedSetId=""; render(); });

  els.start.addEventListener("click", ()=>{
    if (!selectedSetId) return;
    location.href = `quiz.html?set=${encodeURIComponent(selectedSetId)}`;
  });

  els.exit.addEventListener("click", ()=> location.reload());

  (async()=>{
    try{
      await loadSets();
      buildFilters();
      render();
    }catch(err){
      console.error(err);
      els.list.innerHTML = `<div style="color:rgba(238,245,255,.9);font-weight:900;">
        Error: ${String(err.message||err)}
      </div>`;
    }
  })();
</script>
</body>
</html>
