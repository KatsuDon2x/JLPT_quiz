<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Micro Japanese Hack Quiz</title>
  <style>
    :root{
      --bg:#05070b;
      --panel: rgba(18,24,33,.78);
      --line: rgba(255,255,255,.10);
      --text:#eef5ff;
      --muted: rgba(238,245,255,.72);
      --lime:#C1FF72;
      --r:18px;
      --gap:12px;
      --shadow: 0 18px 70px rgba(0,0,0,.62);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(193,255,114,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(255,198,26,.18), transparent 55%),
        radial-gradient(900px 520px at 45% 120%, rgba(77,163,255,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 980px; margin:0 auto; padding: 14px 14px 22px; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 8px 2px 14px; }
    .xbtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      display:grid;place-items:center;
    }

    .title{
      font-weight: 1000;
      letter-spacing:.2px;
      line-height:1.15;
      font-size: 28px;
      margin: 10px 0 14px;
    }
    .subtitle{
      margin-top:6px;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.55;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 14px;
    }

    .filters{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 850;
      outline:none;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .card{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      cursor:pointer;
      transition: transform 80ms ease, border-color 160ms ease, box-shadow 160ms ease;
      min-height: 120px;
      position:relative;
    }
    .card:active{ transform: translateY(1px); }
    .card.selected{
      border-color: rgba(193,255,114,.75);
      box-shadow: 0 0 0 2px rgba(193,255,114,.14) inset, 0 0 26px rgba(193,255,114,.18);
    }
    .thumb{
      width:100%;
      height: 92px;
      object-fit: cover;
      display:block;
      opacity:.92;
      filter: saturate(1.05) contrast(1.05);
    }
    .info{ padding: 10px 10px 12px; }
    .name{
      font-weight: 1000;
      font-size: 14px;
      line-height: 1.2;
    }
    .meta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 900;
    }

    .actions{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .startBtn{
      flex: 1 1 260px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(193,255,114,.55);
      background: linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.55));
      color: rgba(10,18,6,.98);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow:
        0 0 0 2px rgba(255,255,255,.08) inset,
        0 0 34px rgba(193,255,114,.35),
        0 0 70px rgba(193,255,114,.12);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .startBtn:disabled{
      opacity:.42;
      cursor:not-allowed;
      filter: grayscale(.35);
      background: linear-gradient(180deg, rgba(193,255,114,.35), rgba(193,255,114,.16));
      box-shadow: 0 0 0 2px rgba(255,255,255,.05) inset;
    }

    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .title{ font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="xbtn" id="btnExit" aria-label="exit">Ã—</button>
      <div style="opacity:.85;font-weight:900;">Micro Japanese Hack</div>
      <div style="width:42px;"></div>
    </div>

    <div class="title">Choose a Quiz</div>
    <div class="subtitle">Pick one set. (Single select for now.)</div>

    <div class="panel">
      <div class="filters">
        <select id="levelFilter">
          <option value="ALL">All levels</option>
          <option value="A1">A1 / N5</option>
          <option value="A2">A2 / N4</option>
          <option value="B1">B1 / N3</option>
          <option value="B2">B2 / N2</option>
          <option value="C1">C1 / N1</option>
          <option value="C2">C2 / N1</option>
        </select>

        <select id="topicFilter">
          <option value="ALL">All topics</option>
        </select>
      </div>

      <div class="grid" id="cards"></div>

      <div class="actions">
        <button class="startBtn" id="btnStart" disabled>START</button>
      </div>
    </div>
  </div>

  <script>
    const PATH = {
      sets: "assets/quiz/data/sets.csv"
    };

    let SETS = [];
    let selectedSetId = null;

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const n = text[i+1];

        if (inQuotes){
          if (c === '"' && n === '"'){ cur += '"'; i++; continue; }
          if (c === '"'){ inQuotes = false; continue; }
          cur += c; continue;
        }
        if (c === '"'){ inQuotes = true; continue; }
        if (c === ","){ row.push(cur); cur=""; continue; }
        if (c === "\r"){ continue; }
        if (c === "\n"){
          row.push(cur); cur="";
          if (row.some(v => (v||"").trim().length)) rows.push(row);
          row = []; continue;
        }
        cur += c;
      }
      row.push(cur);
      if (row.some(v => (v||"").trim().length)) rows.push(row);

      if (!rows.length) return [];
      const headers = rows.shift().map(h => (h||"").trim());
      return rows.map(cols=>{
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cols[i] ?? ""));
        return obj;
      });
    }

    async function loadSets(){
      const res = await fetch(PATH.sets, { cache:"no-store" });
      if (!res.ok) throw new Error("sets.csv fetch failed: " + res.status);
      const text = await res.text();
      return parseCSV(text);
    }

    function uniq(arr){ return [...new Set(arr)].filter(Boolean); }

    function buildTopicFilter(){
      const sel = document.getElementById("topicFilter");
      const topics = uniq(SETS.map(s => (s.topic||"").trim()));
      for (const t of topics){
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      }
    }

    function passesFilters(s){
      const lv = document.getElementById("levelFilter").value;
      const tp = document.getElementById("topicFilter").value;

      const cefr = (s.level_cefr||"").trim();
      const topic = (s.topic||"").trim();

      if (lv !== "ALL" && cefr !== lv) return false;
      if (tp !== "ALL" && topic !== tp) return false;
      return true;
    }

    function render(){
      const wrap = document.getElementById("cards");
      wrap.innerHTML = "";

      const visible = SETS.filter(passesFilters).sort((a,b)=> (Number(a.sort_order||0) - Number(b.sort_order||0)));

      for (const s of visible){
        const card = document.createElement("div");
        card.className = "card" + (selectedSetId===s.set_id ? " selected" : "");
        const thumb = (s.thumb_image||"").trim();

        const titleEn = (s.title_en||"").trim();
        const titleJa = (s.title_ja||"").trim();
        const band = (s.level_band||"").trim();
        const jlpt = (s.level_jlpt||"").trim();
        const cefr = (s.level_cefr||"").trim();

        card.innerHTML = `
          ${thumb ? `<img class="thumb" src="${thumb}" alt="">` : `<div style="height:92px;background:rgba(255,255,255,.06)"></div>`}
          <div class="info">
            <div class="name">${titleEn || titleJa || s.set_id}</div>
            <div class="meta">
              <span class="badge">${cefr || "-"}/${jlpt || "-"}</span>
              ${band ? `<span class="badge">${band}</span>` : ``}
              ${(s.topic||"") ? `<span class="badge">${s.topic}</span>` : ``}
            </div>
          </div>
        `;

        card.addEventListener("click", ()=>{
          selectedSetId = s.set_id;
          document.getElementById("btnStart").disabled = !selectedSetId;
          render();
        });

        wrap.appendChild(card);
      }

      document.getElementById("btnStart").disabled = !selectedSetId;
    }

    document.getElementById("btnStart").addEventListener("click", ()=>{
      if (!selectedSetId) return;
      location.href = `quiz.html?set=${encodeURIComponent(selectedSetId)}`;
    });

    document.getElementById("levelFilter").addEventListener("change", render);
    document.getElementById("topicFilter").addEventListener("change", render);

    document.getElementById("btnExit").addEventListener("click", ()=>{ /* optional */ });

    (async ()=>{
      try{
        SETS = await loadSets();
        buildTopicFilter();
        render();
      }catch(e){
        alert("Menu load error: " + (e.message || e));
      }
    })();
  </script>
</body>
</html>
