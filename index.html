<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Micro Japanese Hack Quiz</title>

  <style>
    :root{
      --bg:#05070b;

      --panel: rgba(18,24,33,.78);
      --panel2: rgba(10,14,20,.72);
      --line: rgba(255,255,255,.10);

      --text:#eef5ff;
      --muted: rgba(238,245,255,.72);

      --lime:#C1FF72;
      --orange:#FFC61A;
      --blue:#4da3ff;

      --r:18px;
      --gap:12px;
      --shadow: 0 18px 70px rgba(0,0,0,.62);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(193,255,114,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(255,198,26,.18), transparent 55%),
        radial-gradient(900px 520px at 45% 120%, rgba(77,163,255,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{ max-width: 980px; margin:0 auto; padding: 14px 14px 22px; }

    /* ===== TOP BAR ===== */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 8px 2px 14px;
    }
    .leftTop{ display:flex; align-items:center; gap:10px; min-width:220px; }
    .xbtn{
      width:42px;height:42px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:18px;
      cursor:pointer;
      display:grid;place-items:center;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
      letter-spacing:.2px;
    }

    .uiToggle{
      border:1px solid rgba(193,255,114,.35);
      background: rgba(193,255,114,.10);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing:.2px;
      box-shadow:
        0 0 0 2px rgba(193,255,114,.10) inset,
        0 0 22px rgba(193,255,114,.18);
    }
    .uiDot{
      width:10px;height:10px;border-radius:999px;
      background: var(--lime);
      box-shadow: 0 0 22px rgba(193,255,114,.75);
    }
    .uiLabel{ font-size: 13px; opacity: .95; }

    /* ===== MAIN CARD ===== */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardInner{ padding: 14px; }
    .row{ display:flex; gap: var(--gap); align-items:flex-start; flex-wrap:wrap; }

    /* play/pause */
    .speakerBtn{
      width:72px; height:72px; border-radius: 18px;
      border:1px solid rgba(77,163,255,.30);
      background: rgba(77,163,255,.14);
      display:grid; place-items:center;
      cursor:pointer;
      flex: 0 0 auto;
      position: relative;
      overflow:hidden;
      box-shadow:
        0 0 0 2px rgba(77,163,255,.10) inset,
        0 0 24px rgba(77,163,255,.18);
    }
    .speakerBtn::after{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(circle at 30% 30%, rgba(77,163,255,.36), transparent 50%);
      transform: rotate(10deg);
      opacity:.85;
    }
    .speakerBtn > *{ position:relative; z-index:1; }
    .speakerBtn:active{ transform: translateY(1px); }

    .speakerIcon{ width:28px;height:28px; fill: var(--text); opacity:.95; }

    .bubble{
      flex: 1 1 320px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px 14px;
      min-height: 72px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }

    /* ===== Question type block ===== */
    .qtype{
      font-weight: 1000;
      letter-spacing:.2px;
      line-height:1.25;
      font-size: 18px;
    }
    .qtype .enSmall{
      display:block;
      margin-top:6px;
      font-size: 14px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing:.1px;
    }

    /* ===== key sentence ===== */
    .ks{
      margin-top: 12px;
      padding: 14px 14px;
      background: rgba(10,14,20,.58);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      line-height: 1.55;
    }
    .ks .jp{
      font-size: 30px;
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.45;
    }
    .ks .en{
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.55;
    }

    /* ===== ‚Äú‰∏ã„É´„Éì‚Äù ===== */
    .rbWrapBottom{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      line-height:1;
      margin: 0 .06em;
    }
    .rbWrapBottom .rbBase{
      font-size: 1em;
      line-height: 1.05;
      letter-spacing:.02em;
    }
    .rbWrapBottom .rbBottom{
      font-size: .56em;
      line-height: 1;
      opacity: .92;
      transform: translateY(.18em);
      white-space: nowrap;
    }

    /* ===== IMAGE GRID ===== */
    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .imgCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      aspect-ratio: 5 / 4;
      display:grid;
      place-items:center;
      padding: 10px;
    }
    .imgCard img{
      width:100%;
      height:100%;
      object-fit: contain;
      background: rgba(255,255,255,.94);
      border-radius: 12px;
      display:block;
    }

    /* ===== CHOICES ===== */
    .choices{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .choiceBtn{
      min-height: 66px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 15px;
      font-weight: 950;
      padding: 10px 12px;
      cursor:pointer;
      text-align:center;
      line-height: 1.15;
      transition: transform 80ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
    }
    .choiceBtn:active{ transform: translateY(1px); }
    .choiceBtn .sub{
      display:block;
      margin-top:7px;
      color: var(--muted);
      font-weight: 850;
      font-size: 13px;
    }
    .choiceBtn.selected{
      border-color: rgba(77,163,255,.75);
      background: rgba(77,163,255,.22);
      box-shadow:
        0 0 0 2px rgba(77,163,255,.14) inset,
        0 0 26px rgba(77,163,255,.18);
    }

    /* ===== BOTTOM ACTIONS ===== */
    .bottomRow{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .checkBtn{
      flex: 1 1 260px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(193,255,114,.55);
      background: linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.55));
      color: rgba(10,18,6,.98);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      box-shadow:
        0 0 0 2px rgba(255,255,255,.08) inset,
        0 0 34px rgba(193,255,114,.35),
        0 0 70px rgba(193,255,114,.12);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .checkBtn:disabled{
      opacity:.42;
      cursor:not-allowed;
      filter: grayscale(.35);
      box-shadow:
        0 0 0 2px rgba(255,255,255,.05) inset;
      background: linear-gradient(180deg, rgba(193,255,114,.35), rgba(193,255,114,.16));
    }

    .rightIcons{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
    }

    .iconBtn{
      min-height:60px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      padding: 0 14px;
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing:.2px;
      transition: transform 80ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
    }
    .iconBtn:active{ transform: translateY(1px); }

    .iconCircle{
      width:34px;height:34px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
    }
    .iconCircle svg{ width:18px;height:18px; fill: var(--text); opacity:.95; }

    /* Save Ëâ≤ */
    .saveBtn.saved{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.26);
      color:#fff;
      box-shadow: 0 0 18px rgba(255,255,255,.08);
    }
    .saveBtn:not(.saved){
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.10);
      color: rgba(231,238,252,.70);
    }

    /* ‰∏çÊ≠£Ëß£ÊôÇÔºöËô´ÁúºÈè°„Å†„ÅëÂÖâ„Çâ„Åõ„Çã */
    .hintPulse{
      border-color: rgba(193,255,114,.75) !important;
      background: rgba(193,255,114,.12) !important;
      box-shadow:
        0 0 0 2px rgba(193,255,114,.16) inset,
        0 0 34px rgba(193,255,114,.28),
        0 0 80px rgba(193,255,114,.12);
      animation: pulse 1.05s infinite;
    }
    @keyframes pulse{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(-2px); }
      100%{ transform: translateY(0); }
    }
    .hintPulse .iconCircle{
      border-color: rgba(193,255,114,.85);
      background: rgba(193,255,114,.16);
      box-shadow: 0 0 26px rgba(193,255,114,.28);
    }
    .hintPulse .iconCircle svg{
      fill: var(--lime);
      opacity: 1;
    }

    /* ===== TRANSLATION DRAWER ===== */
    .drawer{
      position: fixed;
      left:0; right:0; bottom:0;
      transform: translateY(110%);
      transition: transform 220ms ease;
      background: rgba(10,14,20,.92);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 -18px 70px rgba(0,0,0,.70);
      padding: 14px 16px 18px;
      z-index: 60;
    }
    .drawer.open{ transform: translateY(0%); }

    .drawerInner{ max-width: 980px; margin:0 auto; }
    .drawerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .drawerClose{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size:18px;
      display:grid;place-items:center;
    }
    .drawerTitle{
      font-weight: 1000;
      letter-spacing:.2px;
      opacity:.9;
    }
    .drawerCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .drawerBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(255,255,255,.05);
      line-height: 1.75;
      min-height: 92px;
    }
    .label{
      color: var(--muted);
      font-size: 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      margin-bottom: 6px;
    }

    /* ===== FEEDBACK SHEET ===== */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease;
      z-index: 80;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .sheet{
      position: fixed;
      left:0; right:0; bottom:0;
      transform: translateY(110%);
      transition: transform 220ms ease;
      z-index: 90;
      padding: 12px 16px 18px;
    }
    .sheet.show{ transform: translateY(0%); }

    .sheetInner{
      max-width: 980px;
      margin:0 auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden;
      box-shadow: 0 -22px 80px rgba(0,0,0,.72);
      background: rgba(10,14,20,.92);
      backdrop-filter: blur(10px);
    }
    .sheetBar{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 1100;
      letter-spacing:.2px;
    }
    .sheetBody{
      padding: 14px 16px 16px;
      line-height: 1.55;
      color: rgba(238,245,255,.92);
    }

    .continueBtn{
      width: 100%;
      margin-top: 12px;
      min-height: 60px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: 16px;
      font-weight: 1000;
      cursor:pointer;
    }

    @media (max-width: 720px){
      .choices{ grid-template-columns: 1fr; }
      .drawerCols{ grid-template-columns: 1fr; }
      .ks .jp{ font-size: 26px; }
      .qtype{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="leftTop">
        <button class="xbtn" id="btnExit" aria-label="exit">√ó</button>
        <div class="pills">
          <div class="pill" id="pillQ">Q 1/1</div>
          <div class="pill" id="pillScore">score: 0/1</div>
        </div>
      </div>

      <button class="uiToggle" id="btnToggleUI" type="button" aria-label="toggle ui language">
        <span class="uiDot" aria-hidden="true"></span>
        <span class="uiLabel" id="uiLabel">English UI</span>
      </button>
    </div>

    <div class="card">
      <div class="cardInner">
        <div class="row">
          <button class="speakerBtn" id="btnPlay" type="button" aria-label="play or pause audio">
            <svg class="speakerIcon" id="playIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7L8 5z"></path>
            </svg>
            <svg class="speakerIcon" id="pauseIcon" viewBox="0 0 24 24" aria-hidden="true" style="display:none;">
              <path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"></path>
            </svg>
          </button>

          <div class="bubble">
            <div class="qtype" id="qTypeBox"></div>
          </div>
        </div>

        <div class="ks" id="keySentence"></div>

        <div class="grid" id="imgGrid"></div>

        <div class="choices" id="choices"></div>

        <div class="bottomRow">
          <button class="checkBtn" id="btnCheck" type="button" disabled>„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã / CHECK</button>

          <div class="rightIcons">
            <button class="iconBtn" id="btnTranslate" type="button" aria-label="translation">
              <span class="iconCircle" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M10 4a6 6 0 1 0 3.47 10.92l4.3 4.3a1 1 0 0 0 1.42-1.42l-4.3-4.3A6 6 0 0 0 10 4zm0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"/>
                </svg>
              </span>
            </button>

            <button class="iconBtn saveBtn" id="btnSave" type="button" aria-label="save">
              <span class="iconCircle" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a2 2 0 0 1 2-2zm0 2v14.76l6-3 6 3V4H6z"/>
                </svg>
              </span>
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TRANSLATION DRAWER -->
  <div class="drawer" id="drawer">
    <div class="drawerInner">
      <div class="drawerTop">
        <button class="drawerClose" id="drawerClose" type="button" aria-label="close">√ó</button>
        <div class="drawerTitle">Word List</div>
        <div style="width:42px;"></div>
      </div>

      <div class="drawerCols">
        <div class="drawerBox">
          <div class="label">„Åã„Å™</div>
          <div id="kanaText"></div>
        </div>
        <div class="drawerBox">
          <div class="label">romaji</div>
          <div id="romajiText"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FEEDBACK SHEET -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="sheetInner">
      <div class="sheetBar" id="sheetBar"></div>
      <div class="sheetBody" id="sheetBody"></div>
    </div>
  </div>

  <audio id="sfxPin" preload="auto" src="audio/effect_pin.mp3"></audio>
  <audio id="sfxBu" preload="auto" src="audio/effect_bu.mp3"></audio>
  <audio id="qAudio" preload="auto"></audio>

  <script>
/* =========================================================
   CSV MULTI-QUESTION LOADER (works on GitHub Pages)
   - loads ALL rows from data/quiz.csv
   - uses your existing UI + bottom-ruby conversion
   - Next question after CONTINUE
   ========================================================= */

let QUESTIONS = [];
let idx = 0;

// ===== state =====
let uiMode = "en";           // ÂàùÊúüÔºöEnglish UI
let selectedChoice = null;
let score = 0;
let answered = false;
let isPlaying = false;

const SAVE_KEY = "savedQuestions_v1";
function loadSaved(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set(Array.isArray(arr) ? arr : []);
  }catch(e){ return new Set(); }
}
function storeSaved(set){
  localStorage.setItem(SAVE_KEY, JSON.stringify([...set]));
}
const savedSet = loadSaved();

// ===== elements =====
const uiLabel = document.getElementById("uiLabel");
const btnToggleUI = document.getElementById("btnToggleUI");

const qTypeBox = document.getElementById("qTypeBox");
const keySentence = document.getElementById("keySentence");
const imgGrid = document.getElementById("imgGrid");
const choicesEl = document.getElementById("choices");
const btnCheck = document.getElementById("btnCheck");
const btnTranslate = document.getElementById("btnTranslate");
const btnSave = document.getElementById("btnSave");

const drawer = document.getElementById("drawer");
const drawerClose = document.getElementById("drawerClose");
const kanaText = document.getElementById("kanaText");
const romajiText = document.getElementById("romajiText");

const btnPlay = document.getElementById("btnPlay");
const playIcon = document.getElementById("playIcon");
const pauseIcon = document.getElementById("pauseIcon");

const qAudio = document.getElementById("qAudio");
const sfxPin = document.getElementById("sfxPin");
const sfxBu = document.getElementById("sfxBu");

const pillScore = document.getElementById("pillScore");
const pillQ = document.getElementById("pillQ");

const overlay = document.getElementById("overlay");
const sheet = document.getElementById("sheet");
const sheetBar = document.getElementById("sheetBar");
const sheetBody = document.getElementById("sheetBody");

// ===== helpers =====
function safePlay(a){
  try{ a.currentTime = 0; a.play(); }catch(e){}
}

function parseChoiceLabel(raw){
  const parts = raw.split(/ {2,}/);
  if (parts.length >= 2) return { main: parts[0].trim(), sub: parts.slice(1).join(" ").trim() };
  return { main: raw.trim(), sub: "" };
}

function setSavedUI(){
  const Q = currentQ();
  btnSave.classList.toggle("saved", Q && savedSet.has(Q.id));
}

function openDrawer(){
  drawer.classList.add("open");
  btnTranslate.classList.remove("hintPulse");
}
function closeDrawer(){ drawer.classList.remove("open"); }

function setPlayUI(playing){
  isPlaying = playing;
  playIcon.style.display = playing ? "none" : "block";
  pauseIcon.style.display = playing ? "block" : "none";
}

function updateCheckEnabled(){
  btnCheck.disabled = !selectedChoice || answered;
}

function hideSheet(){
  overlay.classList.remove("show");
  sheet.classList.remove("show");
}

function showSheet(ok){
  overlay.classList.add("show");
  sheet.classList.add("show");

  if (ok){
    sheetBar.style.background = "linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.45))";
    sheetBar.style.color = "rgba(10,18,6,.98)";
    sheetBar.style.textShadow = "0 1px 0 rgba(255,255,255,.25)";
    sheetBar.style.boxShadow = "0 0 34px rgba(193,255,114,.30)";
    sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
      <span>„Äá „ÇÑ„Å£„ÅüÔºÅ</span><span style="opacity:.72">/ Yatta!</span><span style="font-size:22px;">üéâ</span>
    </div>`;
  }else{
    sheetBar.style.background = "linear-gradient(180deg, rgba(255,198,26,.98), rgba(255,198,26,.48))";
    sheetBar.style.color = "rgba(30,18,0,.98)";
    sheetBar.style.textShadow = "0 1px 0 rgba(255,255,255,.20)";
    sheetBar.style.boxShadow = "0 0 34px rgba(255,198,26,.28)";
    sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
      <span>√ó „Åä„Åó„ÅÑÔºÅ</span><span style="opacity:.72">/ Oshƒ´!</span>
    </div>`;
    btnTranslate.classList.add("hintPulse");
  }

  sheetBody.innerHTML = `<button class="continueBtn" id="btnContinue">CONTINUE / „Å§„Å•„Åë„Çã</button>`;
  document.getElementById("btnContinue").addEventListener("click", ()=>{
    hideSheet();
    goNext();   // ‚úÖ next question after continue
  });
}

// ===== ‚Äú‰∏ã„É´„Éì‚Äù =====
function pseudoRubyBottom(html){
  const container = document.createElement("div");
  container.innerHTML = html;

  const rbs = Array.from(container.querySelectorAll("rb"));
  for (const rb of rbs){
    const reading = (rb.textContent || "").trim();
    const prev = rb.previousSibling;

    if (!prev || prev.nodeType !== Node.TEXT_NODE){
      rb.remove();
      continue;
    }

    const txt = prev.textContent || "";
    if (!txt.length){
      rb.remove();
      continue;
    }

    const m = txt.match(/([\u4E00-\u9FFF]+)$/);

    let baseWord = "";
    if (m && m[1]) {
      baseWord = m[1];
      prev.textContent = txt.slice(0, -baseWord.length);
    } else {
      baseWord = txt.slice(-1);
      prev.textContent = txt.slice(0, -1);
    }

    rb.replaceWith(makeRubyBottom(baseWord, reading));
  }
  return container.innerHTML;
}

function makeRubyBottom(base, reading){
  const wrap = document.createElement("span");
  wrap.className = "rbWrapBottom";

  const baseEl = document.createElement("span");
  baseEl.className = "rbBase";
  baseEl.textContent = base;

  const bot = document.createElement("span");
  bot.className = "rbBottom";
  bot.textContent = reading;

  wrap.appendChild(baseEl);
  wrap.appendChild(bot);
  return wrap;
}

// ===== robust CSV parser (supports quoted commas + newlines) =====
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const n = text[i+1];

    if (inQuotes){
      if (c === '"' && n === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQuotes = false; continue; }
      cur += c;
      continue;
    }

    if (c === '"'){ inQuotes = true; continue; }
    if (c === ","){ row.push(cur); cur = ""; continue; }
    if (c === "\r"){ continue; }
    if (c === "\n"){
      row.push(cur); cur = "";
      // ignore fully blank lines
      if (row.some(v => (v || "").trim().length)) rows.push(row);
      row = [];
      continue;
    }
    cur += c;
  }
  // last cell
  row.push(cur);
  if (row.some(v => (v || "").trim().length)) rows.push(row);

  if (!rows.length) return [];
  const headers = rows.shift().map(h => (h||"").trim());
  return rows.map(cols=>{
    const obj = {};
    headers.forEach((h, i)=> obj[h] = (cols[i] ?? ""));
    return obj;
  });
}

async function loadAllQuestions(){
  const res = await fetch("data/quiz.csv", { cache: "no-store" });
  if (!res.ok) throw new Error("CSV fetch failed: " + res.status);
  const text = await res.text();
  const data = parseCSV(text);

  // map CSV rows -> your Q structure
  QUESTIONS = data.map(r => ({
    id: (r.id || "").trim(),
    type: (r.type || "").trim(),
    key_sentence_jp: r.key_sentence_jp || "",
    key_sentence_en: r.key_sentence_en || "",
    qtype_mix: r.qtype_mix || "",
    qtype_jp_only: r.qtype_jp_only || "",
    audio_file: r.audio_file || "",
    image_list: r.image_list || "",
    choices: r.choices || "",
    answer: r.answer || "",
    script_kana: r.script_kana || "",
    script_romaji: r.script_romaji || ""
  })).filter(q => q.id);

  if (!QUESTIONS.length){
    throw new Error("No questions found in CSV.");
  }
}

function currentQ(){
  return QUESTIONS[idx] || null;
}

function resetPerQuestionState(){
  selectedChoice = null;
  answered = false;

  // stop audio when switching questions
  try{ qAudio.pause(); }catch(e){}
  setPlayUI(false);
}

function goNext(){
  if (idx < QUESTIONS.length - 1){
    idx++;
    resetPerQuestionState();
    render();
  }else{
    // end
    overlay.classList.add("show");
    sheet.classList.add("show");
    sheetBar.style.background = "linear-gradient(180deg, rgba(193,255,114,.95), rgba(193,255,114,.45))";
    sheetBar.style.color = "rgba(10,18,6,.98)";
    sheetBar.innerHTML = `<div style="display:flex;align-items:center;gap:10px;font-weight:1100;">
      <span>üéâ FINISH!</span><span style="opacity:.72">/ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</span>
    </div>`;
    sheetBody.innerHTML = `<div style="font-weight:950;margin-bottom:10px;">score: ${score}/${QUESTIONS.length}</div>
      <button class="continueBtn" id="btnRestart">RESTART / „Åï„ÅÑ„Åó„Çá„Åã„Çâ</button>`;
    document.getElementById("btnRestart").addEventListener("click", ()=> location.reload());
  }
}

function render(){
  const Q = currentQ();
  if (!Q) return;

  // top pills
  pillQ.textContent = `Q ${idx+1}/${QUESTIONS.length}`;
  pillScore.textContent = `score: ${score}/${QUESTIONS.length}`;

  // toggle label
  uiLabel.textContent = (uiMode === "en") ? "English UI" : "Êó•Êú¨Ë™ûUI";

  // Question type
  const qtypeHtml = (uiMode === "en") ? (Q.qtype_mix || "") : (Q.qtype_jp_only || "");
  qTypeBox.innerHTML = pseudoRubyBottom(qtypeHtml);

  // key sentence
  const jpHtml = pseudoRubyBottom(Q.key_sentence_jp || "");
  const enLine = (uiMode === "en") ? `<div class="en">${Q.key_sentence_en || ""}</div>` : "";
  keySentence.innerHTML = `<div class="jp">${jpHtml}</div>${enLine}`;

  // audio
  qAudio.src = "audio/" + (Q.audio_file || "");
  qAudio.loop = true;

  // images
  imgGrid.innerHTML = "";
  const imgs = (Q.image_list || "").split("|").map(s=>s.trim()).filter(Boolean).slice(0,4);
  for (const f of imgs){
    const div = document.createElement("div");
    div.className = "imgCard";
    const img = document.createElement("img");
    img.src = "images/" + f;
    img.alt = f;
    div.appendChild(img);
    imgGrid.appendChild(div);
  }

  // choices
  choicesEl.innerHTML = "";
  const choices = (Q.choices || "").split("|").map(s=>s.trim()).filter(Boolean);
  for (const c of choices){
    const {main, sub} = parseChoiceLabel(c);
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choiceBtn" + (selectedChoice===c ? " selected" : "");
    const subHtml = (uiMode === "en" && sub) ? `<span class="sub">${sub}</span>` : (sub ? `<span class="sub">${sub}</span>` : "");
    btn.innerHTML = `<span>${main}</span>${subHtml}`;
    btn.addEventListener("click", ()=>{
      if (answered) return;
      selectedChoice = c;
      render();
      updateCheckEnabled();
    });
    choicesEl.appendChild(btn);
  }

  // drawer
  kanaText.innerHTML = pseudoRubyBottom(Q.script_kana || "");
  romajiText.innerHTML = (Q.script_romaji || "");

  setSavedUI();
  updateCheckEnabled();
  setPlayUI(isPlaying);
}

// ===== events =====
btnToggleUI.addEventListener("click", ()=>{
  uiMode = (uiMode === "en") ? "jp" : "en";
  render();
});

document.getElementById("btnExit").addEventListener("click", ()=> location.reload());

btnTranslate.addEventListener("click", openDrawer);
drawerClose.addEventListener("click", closeDrawer);

btnSave.addEventListener("click", ()=>{
  const Q = currentQ();
  if (!Q) return;
  if (savedSet.has(Q.id)) savedSet.delete(Q.id);
  else savedSet.add(Q.id);
  storeSaved(savedSet);
  setSavedUI();
});

// play/pause
btnPlay.addEventListener("click", ()=>{
  try{
    if (!isPlaying){
      qAudio.play();
      setPlayUI(true);
    }else{
      qAudio.pause();
      setPlayUI(false);
    }
  }catch(e){}
});

btnCheck.addEventListener("click", ()=>{
  const Q = currentQ();
  if (!Q) return;
  if (!selectedChoice || answered) return;

  const ok = (selectedChoice.trim() === (Q.answer || "").trim());
  answered = true;

  if (ok){
    score++;
    safePlay(sfxPin);
    showSheet(true);
  }else{
    safePlay(sfxBu);
    showSheet(false);
  }
  updateCheckEnabled();
  render();
});

overlay.addEventListener("click", hideSheet);

// ===== start =====
(async ()=>{
  try{
    await loadAllQuestions();
    idx = 0;
    resetPerQuestionState();
    render();
  }catch(err){
    console.error(err);
    keySentence.innerHTML = `<div class="jp" style="font-size:18px;font-weight:900;">
      CSV Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${String(err.message || err)}
    </div>`;
  }
})();
</script>
</body>
</html>
